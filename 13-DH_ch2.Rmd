
# Partial Relationship & Multiple Regression


Darlington & Hayes, Chapter 2

Outside resource
* https://www.harshaash.com/R/part-and-partial-corr/
* https://dstanley4.github.io/psyc4780bookdown/multiple-regression.html

Reference:

* Knapp, T. R. (1996). [Semi-Partial Correlations: I Don't Need Them; You Can Have Them.](https://scholarworks.bgsu.edu/cgi/viewcontent.cgi?article=1631&context=mwer) Mid-Western Educational Researcher, 9(4), 4.

## PREPARATION

### Load Packages

```{r, eval=FALSE}
library(remotes)
remotes::install_github("sarbearschwartz/apaSupp")
```


```{r}
library(tidyverse)
library(broom)
library(flextable)
library(apaSupp)
library(modelsummary)
library(ppcor)
library(jtools)
library(olsrr)
library(ggpubr)
library(ggResidpanel)
```


### Load Data

Manually enter the data set provided on page 44 in Table 3.1



```{r}
df_loss <- tibble::tribble(~id, ~exer, ~diet, ~loss,
                           1, 0, 2,  6, 
                           2, 0, 4,  2,
                           3, 0, 6,  4,
                           4, 2, 2,  8,
                           5, 2, 4,  9,
                           6, 2, 6,  8,
                           7, 2, 8,  5,
                           8, 4, 4, 11,
                           9, 4, 6, 13,
                           10, 4, 8, 9)
```



```{r}
df_loss %>% 
  dplyr::select("ID" = id,
                "Exercise\nFrequency" = exer,
                "Food\nIntake" = diet,
                "Weight\nLoss" = loss) %>% 
  flextable::flextable() %>% 
  apaSupp::theme_apa(caption = "D&H Table 3.1: Exercise, Food Intake, and Weight Loss") %>% 
  flextable::colformat_double(digits = 0) %>% 
  flextable::footnote(part = "header", 
                      i = 1, j = 2:4, 
                      value = as_paragraph(c("Weekly average of hours/day",
                                             "Daily average of 100s of calories above recommendation",
                                             "Weekly average of 100s of grams/week")))
```



## EXPLORATORY

### Summary Statistics

```{r}
df_loss %>% 
  dplyr::select("Exercise Frequency" = exer,
                "Food Intake" = diet,
                "Weight Loss" = loss) %>% 
  apaSupp::tab_desc(caption = "Summary Statistics") %>% 
  flextable::footnote(i = 1:3, j = 1, 
                      value = as_paragraph(c("Weekly average of hours/day",
                                             "Daily average of 100s of calories above recommendation",
                                             "Weekly average of 100s of grams/week")))
```



### Visualizations

```{r, fig.cap= "D&H Figure 3.1 (page 45) An example with positive simple association and negative partial association - BASIC"}
df_loss %>% 
  ggplot(aes(x = diet,
             y = loss)) +
  geom_point(aes(shape = factor(exer))) 
```

```{r, fig.cap= "D&H Figure 3.1 (page 45) An example with positive simple association and negative partial association - BETTTER"}
df_loss %>% 
  ggplot(aes(x = diet,
             y = loss)) +
  geom_point(aes(shape = factor(exer),
                 color = factor(exer)),
             size = 3)  +
  theme_bw() +
  labs(x = "Observed Food Intake\nDaily average of 100s of calories above recommendation",
       y = "Observed Weight Loss\nWeekly average of 100s of grams/week",
       shape = "Exercise Frequency\nWeekly average of hours/day",
       color = "Exercise Frequency\nWeekly average of hours/day") +
  theme(legend.position = "bottom")
```

```{r, fig.cap= "D&H Figure 3.1 (page 45) An example with positive simple association and negative partial association - WORST"}
df_loss %>% 
  dplyr::mutate(exer = factor(exer)) %>% 
  ggplot(aes(x = diet,
             y = loss)) +
  geom_point(size = 3)  +
  theme_bw() +
  labs(x = "Observed Food Intake\n(Daily average of 100s of calories above recommendation)",
       y = "Observed Weight Loss\n(Weekly average of 100s of grams/week)",
       shape = "Exercise Frequency\n(Weekly average of hours/day)",
       color = "Exercise Frequency\n(Weekly average of hours/day)") +
  theme(legend.position = "bottom") +
  geom_smooth(aes(group = 1),
              method = "lm",
              formula = y ~ x,
              se = FALSE)
```


```{r, fig.cap= "D&H Figure 3.1 (page 45) An example with positive simple association and negative partial association - BEST"}
df_loss %>% 
  dplyr::mutate(exer = factor(exer)) %>% 
  ggplot(aes(x = diet,
             y = loss,
             group = exer)) +
  geom_point(aes(shape = exer,
                 color = exer),
             size = 3)  +
  theme_bw() +
  labs(x = "Observed Food Intake\n(Daily average of 100s of calories above recommendation)",
       y = "Observed Weight Loss\n(Weekly average of 100s of grams/week)",
       shape = "Exercise Frequency\n(Weekly average of hours/day)",
       color = "Exercise Frequency\n(Weekly average of hours/day)") +
  theme(legend.position = "bottom") +
  geom_smooth(aes(color = exer),
              method = "lm",
              formula = y ~ x,
              se = FALSE)
```



## REGRESSION

### Fit the models

```{r}
fit_lm_exer <- lm(loss ~ exer,
                  data = df_loss)

fit_lm_diet <- lm(loss ~ diet,
                  data = df_loss)

fit_lm_both <- lm(loss ~ exer + diet,
                  data = df_loss)
```

### Output

```{r}
olsrr::ols_regress(fit_lm_exer)
```


```{r}
olsrr::ols_regress(fit_lm_diet)
```


```{r}
olsrr::ols_regress(fit_lm_both)
```

### Equations

$$
\widehat{loss} = 4 + 1.75(exercise) \\

\widehat{loss} = 7.14 + 0.07(food) \\

\widehat{loss} = 6 + 2(exercise) -0.5(food)
$$



### Tables

```{r}
list("Just\nExercise" = fit_lm_exer,
     "Just\nDiet" = fit_lm_diet,
     "Exercise\nand Diet" = fit_lm_both) %>% 
  modelsummary::modelsummary(output = "flextable",
                             fmt = 2,
                             estimate = "{estimate}",
                             statistic = NULL,
                             gof_map = NA,
                             coef_rename = c("exer" = "Exercise Frequency",
                                             "diet" = "Food Intake")) %>% 
  apaSupp::theme_apa(caption = "Parameter Estimates for Weight Loss Regressed on Exercise Frequency and Food Intake - BASIC")
```


```{r}
tab_mods <- list("Just Exercise" = fit_lm_exer,
                 "Just Diet" = fit_lm_diet,
                 "Exercise and Diet" = fit_lm_both) %>% 
  modelsummary::modelsummary(output = "flextable",
                             fmt = 2,
                             estimate = "{estimate} ({std.error})",
                             statistic = "{p.value}{stars}",
                             stars = c('*' = .05, '**' = .01, '***' = .001),
                             gof_map = c("r.squared", 
                                         #"adj.r.squared",
                                         "rmse"),
                             coef_rename = c("exer" = "Exercise Frequency",
                                             "diet" = "Food Intake")) %>% 
  apaSupp::theme_apa(caption = "Parameter Estimates for Weight Loss Regressed on Exercise Frequency and Food Intake - BETTER",
                     p_note = "apa",
                     general_note = "Dependent variable is average weekly weight lost in 100s of grams. ") %>% 
  flextable::hline(i = 6) %>% 
  flextable::footnote(i = c(3, 5), j = 1, 
                      value = as_paragraph(c("Weekly average of hours/day",
                                             "Daily average of 100s of calories above recommendation")))

tab_mods
```

```{r}
flextable::save_as_docx(tab_mods,
                        path = "tab_mods.docx")
```




```{r}
modelsummary::modelsummary(models = list("Weight Loss" = fit_lm_both),
                           output = "flextable",
                           fmt = 2,
                           coef_rename = c("exer" = "Exercise Frequency",
                                           "diet" = "Food Intake")) %>% 
  apaSupp::theme_apa(caption = "Parameter Estimates for Weight Loss Regressed on Exercise Frequency and Food Intake - BETTER",
                     p_note = "apa",
                     general_note = "Dependent variable is average weekly weight lost in 100s of grams. ") %>% 
  flextable::hline(i = 6) %>% 
  flextable::footnote(i = c(3, 5), j = 1, 
                      value = as_paragraph(c("Weekly average of hours/day",
                                             "Daily average of 100s of calories above recommendation")))
```




### Semipartial Correlation

```{r}
df_loss %>% 
  dplyr::select(-id) %>% 
  ppcor::spcor()
```


### Partial Correlation

```{r}
df_loss %>% 
  dplyr::select(-id) %>% 
  ppcor::pcor()
```


### Standardized Regression Coefficients


```{r}
lm(scale(loss) ~ scale(exer) + scale(diet),
   data = df_loss) %>% 
  coef()
```


```{r}
effectsize::eta_squared(fit_lm_both, partial = FALSE)
```



```{r}
effectsize::r2_semipartial(fit_lm_both)
```



