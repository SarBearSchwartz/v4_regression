# Ex: Logistic - Maternal Risk (Hoffman)

Maternal Risk Factor for Low Birth Weight Delivery

Compiled: `r format(Sys.time(), '%B %d, %Y')`

```{r, include=FALSE}
knitr::opts_chunk$set(comment     = "",
                      echo        = TRUE, 
                      warning     = FALSE, 
                      message     = FALSE,
                      fig.align   = "center", # center all figures
                      fig.width   = 6,        # set default figure width to 4 inches
                      fig.height  = 4)        # set default figure height to 3 inches
```


## PREPARATION

### Load Packages

```{r, message=FALSE, error=FALSE, warning=FALSE}

# library(remotes)
# remotes::install_github("sarbearschwartz/apaSupp")  # updated: 4/12/25
# remotes::install_github("ddsjoberg/gtsummary")


library(tidyverse)
library(haven)        
library(naniar)
library(apaSupp)
library(performance) 
library(interactions)
library(GGally)
```



### Load Data

More complex example demonstrating modeling decisions

Another set of data from a study investigating predictors of low birth weight

* `id` infant's unique identification number

Dependent variable (DV) or outcome    

* `low` Low birth weight (outcome) 
- 0 = birth weight >2500 g (normal)
- 1 = birth weight < 2500 g (low))  

* `bwt` actual infant birth weight in grams *(ignore for now)*


Independent variables (IV) or predictors

* `age` Age of mother, in years
* `lwt` Mother's weight at last menstrual period, in pounds
* `race` Race: 1 = White, 2 = Black, 3 = Other
* `smoke` Smoking status during pregnancy:1 = Yes, 0 = No
* `ptl` History of premature labor: 0 = None, 1 = One, 2 = two, 3 = three
* `ht` History of hypertension: 1 = Yes, 0 = No
* `ui` Uterine irritability: 1 = Yes, 0 = No
* `ftv` Number of physician visits in 1st trimester: 0 = None, 1 = One, ... 6 = six



The data is saved in a text file (`.txt`) without any labels.

```{r}
df_txt <- read.table("https://raw.githubusercontent.com/CEHS-research/data/master/Regression/lowbwt.txt", 
                     header = TRUE, 
                     sep = "", 
                     na.strings = "NA", 
                     dec = ".", 
                     strip.white = TRUE)

tibble::glimpse(df_txt)
```



### Wrangle Data


```{r}
df_mom <- df_txt %>% 
  dplyr::mutate(id = factor(id)) %>% 
  dplyr::mutate(low = low %>% 
                  factor() %>% 
                  forcats::fct_recode("birth weight >2500 g (normal)" = "0",
                                      "birth weight < 2500 g (low)"   = "1")) %>% 
  dplyr::mutate(race = race %>% 
                  factor() %>% 
                  forcats::fct_recode("White" = "1",
                                      "Black" = "2",
                                      "Other" = "3")) %>% 
  dplyr::mutate(ptl_any = as.numeric(ptl > 0)) %>%         # collapse into 0 = none vs. 1 = at least one
  dplyr::mutate(ptl = factor(ptl)) %>%                     # declare the number of pre-term labors to be a factor: 0, 1, 2, 3
  dplyr::mutate_at(vars(smoke, ht, ui, ptl_any),           # declare all there variables to be factors with the same two levels
                   factor,
                   levels = 0:1,
                   labels = c("No", "Yes")) 
```


Display the structure of the 'clean' version of the dataset

```{r}
str(df_mom)
```

```{r}
tibble::glimpse(df_mom)
```




## EXPLORATORY DATA ANALYSIS

### Missing Data


```{r}
df_mom %>% 
  dplyr::select("Low Birth Weight Delivery" = low,
                "Age, years" = age, 
                "Weight, pounds" = lwt, 
                "Race" = race, 
                "Smoking During pregnancy" = smoke, 
                "History of Premature Labor, any" = ptl_any, 
                "History of Premature Labor, number" = ptl, 
                "History of Hypertension" = ht, 
                "Uterince Irritability" = ui, 
                "1st Tri Dr Visits" = ftv) %>% 
  naniar::miss_var_summary() %>%
  dplyr::select(Variable = variable,
                n = n_miss) %>% 
  flextable::flextable() %>% 
  apaSupp::theme_apa(caption = "Missing Data by Variable")
```



## Exploratory Data Analysis


### Summary


```{r}
df_mom %>% 
  dplyr::select("Low Birth Weight Delivery" = low,
                "Race" = race, 
                "Smoking During pregnancy" = smoke, 
                "History of Premature Labor, any" = ptl_any, 
                "History of Premature Labor, number" = ptl, 
                "History of Hypertension" = ht, 
                "Uterince Irritability" = ui) %>% 
  apaSupp::tab_freq(caption = "Summary of Categorical Variables")
```



```{r}
df_mom %>% 
  dplyr::select("Age, yrs" = age, 
                "Weight, lbs" = lwt, 
                "1st Tri Dr Visits" = ftv) %>% 
  apaSupp::tab_desc(caption = "Summary of Continuous Variables")
```





## UNADJUSTED

> Unadjusted Models

### Fit Models

```{r}
fit_glm_age   <- glm(low ~ age,     family = binomial(link = "logit"), data = df_mom)
fit_glm_lwt   <- glm(low ~ lwt,     family = binomial(link = "logit"), data = df_mom)
fit_glm_race  <- glm(low ~ race,    family = binomial(link = "logit"), data = df_mom)
fit_glm_smoke <- glm(low ~ smoke,   family = binomial(link = "logit"), data = df_mom)
fit_glm_ptl   <- glm(low ~ ptl_any, family = binomial(link = "logit"), data = df_mom)
fit_glm_ht    <- glm(low ~ ht,      family = binomial(link = "logit"), data = df_mom)
fit_glm_ui    <- glm(low ~ ui,      family = binomial(link = "logit"), data = df_mom)
fit_glm_ftv   <- glm(low ~ ftv,     family = binomial(link = "logit"), data = df_mom)
```


### Parameter Tables


Note: the parameter estimates here are for the LOGIT scale, not the odds ration (OR) or even the probability.

```{r}
apaSupp::tab_glms(list(fit_glm_age, fit_glm_lwt, fit_glm_race, fit_glm_smoke),
                  narrow = TRUE,
                  fit = NA,
                  pr2 = "tjur")
```

```{r}
apaSupp::tab_glms(list(fit_glm_ptl, fit_glm_ht, fit_glm_ui, fit_glm_ftv),
                  narrow = TRUE,
                  fit = NA,
                  pr2 = "tjur")
```





## MAIN EFFECTS ONLY

Main-effects multiple logistic regression model

```{r}
fit_glm_mains <- glm(low ~ age + lwt + race + smoke + ptl_any + ht + ui,
                     family = binomial(link = "logit"), 
                     data = df_mom)
```


```{r}
apaSupp::tab_glm(fit_glm_mains)
```


## INTERACTIONS

Before removing non-significant main effects, test plausible interactions

Try the following interactions:

* Age and Weight  

* Age and Smoking

* Weight and Smoking

```{r}
fit_glm_mains_aw <- glm(low ~ age + lwt + race + smoke + ptl_any + ht + ui + age:lwt,
                        family = binomial(link = "logit"), 
                        data = df_mom)

fit_glm_mains_as <- glm(low ~ age + lwt + race + smoke + ptl_any + ht + ui + age:smoke,
                        family = binomial(link = "logit"), 
                        data = df_mom)

fit_glm_mains_ws <- glm(low ~ age + lwt + race + smoke + ptl_any + ht + ui + lwt:smoke,
                        family = binomial(link = "logit"), 
                        data = df_mom)
```



```{r}
apaSupp::tab_glms(list("Age-Weight"     = fit_glm_mains_aw,
                       "Age-Smoking"    = fit_glm_mains_as,
                       "Weight-Smoking" = fit_glm_mains_ws),
                  narrow = TRUE)
```

```{r}
apaSupp::tab_glm_fits(list("Only Mains"     = fit_glm_mains,
                           "Age-Weight"     = fit_glm_mains_aw,
                           "Age-Smoking"    = fit_glm_mains_as,
                           "Weight-Smoking" = fit_glm_mains_ws))
```



```{r}
anova(fit_glm_mains, fit_glm_mains_aw, test = 'LRT')
```


```{r}
anova(fit_glm_mains, fit_glm_mains_as, test = 'LRT')
```


```{r}
anova(fit_glm_mains, fit_glm_mains_ws, test = 'LRT')
```








## PARSAMONY

No interactions are  significant
Remove non-significant main effects


Since the mother's age is theoretically a meaningful variable, it should probably be retained.

Remove "UI" since its not significant

```{r}
fit_glm_trim <- glm(low ~ age + lwt + race + smoke + ptl_any + ht,
                    family = binomial(link = "logit"), 
                    data = df_mom)
```


```{r}
apaSupp::tab_glm(fit_glm_trim)
```




## CENTER & SCALE

Since the mother's age is theoretically a meaningful variable, it should probably be retained.

Revise so that age is interpreted in 5-year and pre-pregnancy weight in 20 lb increments and the intercept has meaning.



```{r}
fit_glm_final <- glm(low ~ I((age - 20)/5) + I((lwt - 125)/20) + race + smoke + ptl_any + ht,
                     family = binomial(link = "logit"), 
                     data = df_mom)
```

```{r}
apaSupp::tab_glm(fit_glm_final,
                 var_labels = c())
```

### Marginal Model Plot

#### Focus on: Mother's Age, weight, and race

```{r}
interactions::interact_plot(model = fit_glm_6,
                            pred = lwt,
                            modx = race,
                            mod2 = age)
```



```{r, fig.width=8, fig.height=6}
effects::Effect(focal.predictors = c("age", "lwt", "race"),
                mod = fit_glm_6,
                xlevels = list(age = c(20, 30, 40),
                               lwt = seq(from = 80, to = 250, by = 5))) %>% 
  data.frame() %>% 
  dplyr::mutate(age_labels = glue("Mother Age: {age}")) %>% 
  ggplot(aes(x = lwt,
             y = fit)) +
  geom_line(aes(color = race,
                linetype = race),
            size = 1) +
  theme_bw() +
  facet_grid(.~ age_labels) +
  labs(title = "Risk of Low Birth Weight",
       subtitle = "Illustates risk given mother is a non-smoker, without a history of pre-term labor or hypertension",
       x = "Mother's Weight Pre-Pregnancy, pounds",
       y = "Predicted Probability\nBaby has Low Birth Weight (< 2500 grams)",
       color    = "Mother's Race",
       linetype = "Mother's Race") +
  theme(legend.position = c(1, 1),
        legend.justification = c(1.1, 1.1),
        legend.background = element_rect(color = "black"),
        legend.key.width = unit(2, "cm")) +
  scale_linetype_manual(values = c("longdash", "dotted", "solid")) +
  scale_color_manual(values = c( "coral2", "dodger blue", "gray50"))
```

#### Focus on: Mother's weight and smoking status during pregnancy, as well as history of any per-term labor and hypertension

```{r}
interactions::interact_plot(model = fit_glm_6,
                            pred = lwt,
                            modx = smoke,
                            mod2 = ptl_any)
```


```{r}
interactions::interact_plot(model = fit_glm_6,
                            pred = lwt,
                            modx = smoke,
                            mod2 = ht)
```

```{r, fig.width=8, fig.height=6}
effects::Effect(focal.predictors = c("lwt", "smoke", "ptl_any", "ht"),
                fixed.predictors = list(age = 20),
                mod = fit_glm_6,
                xlevels = list(lwt = seq(from = 80, to = 250, by = 5))) %>% 
  data.frame() %>% 
  dplyr::mutate(smoke = forcats::fct_rev(smoke)) %>% 
  dplyr::mutate(ptl_any_labels = glue("History of Preterm Labor: {ptl_any}")) %>% 
  dplyr::mutate(ht_labels = glue("History of Hypertension: {ht}") %>% forcats::fct_rev()) %>% 
  ggplot(aes(x = lwt,
             y = fit)) +
  geom_line(aes(color = smoke,
                linetype = smoke),
            size = 1) +
  theme_bw() +
  facet_grid(ht_labels ~ ptl_any_labels) +
  labs(title = "Risk of Low Birth Weight",
       subtitle = "Illustates risk given the mother is 20 years old and white",
       x = "Mother's Weight Pre-Pregnancy, pounds",
       y = "Predicted Probability\nBaby has Low Birth Weight (< 2500 grams)",
       color    = "Mother Smoked",
       linetype = "Mother Smoked") +
  theme(legend.position = c(1, .5),
        legend.justification = c(1.1, 1.15),
        legend.background = element_rect(color = "black"),
        legend.key.width = unit(1.5, "cm")) +
  scale_linetype_manual(values = c("longdash", "solid")) +
  scale_color_manual(values = c( "coral2", "dodger blue"))
```

